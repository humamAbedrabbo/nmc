@page

@using Microsoft.EntityFrameworkCore

@{
    ViewBag.PageTitle = _localizer["Select Room"];
}

@functions{

    public Inpatient Inpatient { get; set; }

    [BindProperty(SupportsGet = true)]
    public int Id { get; set; }

    public IEnumerable<Booking> Bookings { get; set; }

    public async Task<IActionResult> OnGetAsync()
    {
        Inpatient = (await _mem.GetInpatients()).Where(x => x.Id == Id).FirstOrDefault();

        if(Inpatient == null)
        {
            return RedirectToPage("/NotFound");
        }

        Bookings = await _mem.GetBookings();

        return Page();
    }

    public async Task<IActionResult> OnPostUseBookingAsync(int bookinId)
    {
        var booking = await _ctx.Bookings
            .Include(x => x.Allocations)
            .Where(x => x.Id == bookinId)
            .FirstOrDefaultAsync();

        var inpatient = await _ctx.Inpatients
            .Include(x => x.Patient)
            .Where(x => x.Id == Id)
            .FirstOrDefaultAsync();

        inpatient.BookingId = booking.Id;
        inpatient.RoomNo = booking.RoomNo;
        inpatient.MinDownPayment = booking.DownPayment;
        inpatient.ReferrerId = booking.DoctorId;
        inpatient.AdmissionNote = booking.Message;

        foreach (var item in booking.Allocations)
        {
            item.InpatientId = inpatient.Id;
            item.PatientId = inpatient.PatientId;
            item.Status = RoomStatus.Reserved;
        }

        await _ctx.SaveChangesAsync();
        _mem.Reset(nameof(Booking));
        _mem.Reset(nameof(Inpatient));

        return RedirectToPage("./SelectRoom", new { Id = Id });
    }

}

<div class="content">
    <div class="row">
        <div class="col-sm-5 col-5">
            <h4 class="page-title ">@ViewBag.PageTitle</h4>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card-box">
                <div class="card-body">
                    <div class="card-title">@_localizer["Inpatient Details"]</div>

                    <input asp-for="Id" type="hidden" />

                    <div class="row">
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.AdmissionTypeId" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.AdmissionType.Name" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.AdmissionDate" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.AdmissionDate" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.AdmissionNote" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.AdmissionNote" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.WardId" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.Ward.Name" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.ReferrerId" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.Referrer.Name" class="form-control" />
                            </div>
                    </div>
                    <div class="row">
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.Name" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.Name" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.Gender" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.Gender" class="form-control" />
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.IdentityNo" class="col-form-label"></label>
                                <input readonly asp-for="Inpatient.IdentityNo" class="form-control" />
                            </div>
                    </div>
                    <div class="row">
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.BookingId" class="col-form-label"></label>
                                <input readonly hidden="@(!Inpatient.BookingId.HasValue)" asp-for="Inpatient.Booking.Name" class="form-control" />
                                
                                <a hidden="@(Inpatient.BookingId.HasValue)" asp-page="./AddBooking" asp-route-inpatientId="@Id" class="btn btn-primary mx-2">@_localizer["New Booking"]</a>
                            </div>
                            <div class="form-group col-md-4">
                                <label asp-for="Inpatient.Booking.RoomNo" class="col-form-label"></label>
                                <input readonly hidden="@(!Inpatient.BookingId.HasValue)" asp-for="Inpatient.Booking.RoomNo" class="form-control" />
                            </div>
                            <div class="form-group col-md-2">
                                <label asp-for="Inpatient.Booking.From" class="col-form-label"></label>
                                <input readonly hidden="@(!Inpatient.BookingId.HasValue)" asp-for="Inpatient.Booking.From" class="form-control" />
                            </div>
                            <div class="form-group col-md-2">
                                <label asp-for="Inpatient.Booking.To" class="col-form-label"></label>
                                <input readonly hidden="@(!Inpatient.BookingId.HasValue)" asp-for="Inpatient.Booking.To" class="form-control" />
                            </div>
                    </div>
                </div>
            </div>

            <div class="card-box" hidden="@Inpatient.BookingId.HasValue">
                <div class="card-body">
                    <div class="card-title">@_localizer["Select Booking"]</div>
                    <div class="table-responsive">
                        <table class="table text-nowrap table-striped custom-table mb-0 datatable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().Name)</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().RequestDate)</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().Doctor.Name)</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().RoomNo)</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().From)</th>
                                    <th>@Html.DisplayNameFor(p => p.Bookings.FirstOrDefault().To)</th>

                                    <th class="text-center">@_localizer["Status"]</th>
                                    <th class="text-center">@_localizer["Status Action"]</th>
                                    @*<th class="text-right">@_localizer["Action"]</th>*@
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Bookings.Where(x => x.Allocations.All(y => (y.InpatientId == Id || !y.InpatientId.HasValue))))
                                {
                                    <tr>
                                        <td>@item.Id</td>
                                        <td>@item.Name</td>
                                        <td><date value="@item.RequestDate"></date></td>
                                        <td>@item.Doctor?.Name</td>
                                        <td>@item.RoomNo</td>
                                        <td><date value="@item.From"></date></td>
                                        <td><date value="@item.To"></date></td>
                                        <td class="text-center">@item.Status</td>
                                        <td class="text-center">
                                            <form method="post" asp-page-handler="UseBooking" asp-route-bookingId="@item.Id">
                                                <button type="submit" class="btn btn-primary" role="button">@_localizer["Select"]</button>

                                            </form>
                                        </td>
                                    </tr>

                                }

                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{

    <partial name="_ValidationScriptsPartial" />

}